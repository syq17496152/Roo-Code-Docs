# 提示结构

本页面解释了 Roo Code 中提示的技术结构 - 消息是如何构建并发送给大语言模型（LLM）的。

---

## 核心消息类型

Roo Code 在与 LLM 通信时使用三种主要消息类型：

- **系统提示**：定义 Roo 功能、角色和操作规则的初始指令
- **用户消息**：您（用户）发送给 Roo 的内容
- **助手消息**：LLM 基于您的请求生成的响应

在 API 层面，还存在第四种消息角色：

- **工具消息**：从工具执行返回的结果，作为输入发送回 LLM

理解这些消息类型有助于您更有效地使用 Roo，并且对于故障排查或高级自定义非常有价值。

---

## 系统提示

系统提示是 Roo 行为的基础。它包含：

- **角色定义**：根据所选模式（代码、询问、调试等）确定的核心角色指令
- **工具描述**：有关可用工具的详细信息，包括参数和示例
- **工具使用指南**：关于如何使用工具的规则（顺序执行、等待结果等）
- **功能**：描述 Roo 在当前环境中的能力
- **可用模式**：所有可用模式及其描述的列表
- **操作规则**：处理文件、项目结构和用户交互的关键准则
- **系统信息**：关于您环境的细节（操作系统、shell、工作目录）
- **自定义指令**：您的全局和模式特定的自定义设置

系统提示会在每次与 Roo 交互时动态生成，适应您当前的模式、可用工具和自定义设置。

### 自定义系统提示

高级用户可以通过在工作区放置一个 `.roo/system-prompt-<mode_slug>` 文件来为特定模式创建自定义系统提示。当存在此文件时，Roo 会使用该文件代替生成的标准系统提示部分，允许对该模式下的 Roo 行为进行完全自定义。

---

## 用户消息

用户消息包含您对 Roo 的直接输入，以及附加的上下文信息：

- **您的查询**：在聊天界面中输入的文本
- **图像**：消息中包含的任何图像（适用于支持的模型）
- **环境详情**：自动追加的工作区状态信息：
  - 打开的文件/标签页
  - 光标位置
  - 包含输出的活动终端
  - 最近修改的文件
  - 当前时间
  - 令牌/成本信息
  - 当前模式
  - 文件列表（在初始连接时）

这种自动化的上下文丰富化帮助 Roo 理解您的工作区，而无需您显式描述它。

---

## 助手消息

助手消息是 LLM 的响应，可能包括：

- **文本响应**：对您查询的直接回答
- **思考过程**：启用时可见的内部推理过程
- **工具调用**：请求使用特定工具（如读取文件或执行命令）

请注意，虽然助手消息包含工具调用，但这些工具的结果会通过单独的工具消息发送给 LLM，而不是作为助手消息本身的一部分。

---

## 消息流

以下是这些组件如何协同工作：

1. **初始设置**：Roo 根据所选模式和配置生成系统提示
2. **用户输入**：您发送一条消息，该消息会添加环境详情
3. **LLM 处理**：LLM 接收所有先前消息以及您的新输入
4. **助手响应**：LLM 生成响应，可能会使用工具
5. **工具执行**：如果 LLM 请求工具，Roo 将执行该工具并提供结果
6. **对话历史**：所有消息都以结构化历史记录形式保存以供上下文参考

---

## 技术实现

内部，Roo 的提示构建由几个组件处理：

- **系统提示生成**：`src/core/prompts/system.ts` 中的 `SYSTEM_PROMPT` 函数组装完整的系统提示
- **分段生成器**：专门的函数创建系统提示的每个部分
- **消息转换**：提供商专用的转换器将 Roo 的内部消息格式转换为每个 LLM API 所需的格式
- **自定义提示加载**：`loadSystemPromptFile` 函数检查并处理自定义系统提示文件

---

## 支持提示

除了主聊天流程外，Roo 还为特定代码操作使用专门的模板：

- **代码动作提示**：用于 "解释"、"修复"、"改进" 或 "添加到上下文" 等命令
- **基于模板**：从 `src/shared/support-prompt.ts` 中的模板生成
- **独立上下文**：通常不依赖主聊天历史记录
- **任务特定格式**：针对执行的特定代码任务优化

这些支持提示在正常对话流之外工作，为特定编码任务提供专注的帮助。