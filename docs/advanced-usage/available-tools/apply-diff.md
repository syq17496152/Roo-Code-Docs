# apply_diff

`apply_diff` 工具通过指定要替换的确切内容，对文件进行精确、细致的更改。它使用一种复杂的策略来查找和应用更改，同时保持正确的代码格式和结构。

---

## 参数

该工具接受以下参数：

- `path` (必填)：要修改的文件的路径，相对于当前工作目录。
- `diff` (必填)：使用特定于当前差异策略的格式定义更改的搜索/替换块。
- `start_line` (可选)：搜索内容开始位置的提示。_注意：此顶层参数似乎未被当前主策略使用，主策略依赖于 `:start_line:` 内容内的行号提示。_
- `end_line` (可选)：搜索内容结束位置的提示。_注意：此顶层参数似乎未被当前主策略使用。_

---

## 功能说明

此工具通过模糊匹配（基于归一化字符串的 Levenshtein 距离）并结合行号提示来定位和替换内容，对现有文件应用针对性更改。与简单的搜索和替换不同，它会根据提供的内容和位置提示识别出确切的代码块进行替换。

---

## 使用场景

- 当 Roo 需要在不重写整个文件的情况下对现有代码进行精确更改时。
- 当重构代码的特定部分同时保持周围上下文不变时。
- 当以精确的方式修复现有代码中的错误时。
- 当实现仅修改文件某些部分的功能增强时。

---

## 主要功能

- 使用模糊匹配（基于归一化字符串的 Levenshtein 距离）并结合 `:start_line:` 提示，使用可配置的置信度阈值（通常为 0.8-1.0）。
- 通过 `BUFFER_LINES`（默认为 40）提供匹配周围的上下文。
- 在提示的起始行附近的可配置上下文窗口（`bufferLines`）内执行中向外的搜索。
- 通过替换确切的代码块来被动保留代码格式和缩进。
- 在应用更改之前，以差异视图的形式显示更改以便用户审查和编辑。
- 跟踪每个文件的连续错误（`consecutiveMistakeCountForApplyDiff`）以防止重复失败。
- 验证文件访问是否符合 `.rooignore` 规则。
- 有效处理多行编辑。

---

## 局限性

- 在可靠识别时最适合独特、有区别的代码部分。
- 在非常大的文件或高度重复的代码模式中性能可能会有所变化。
- 如果内容模糊不清，模糊匹配有时可能会选择错误的位置。
- 每个差异策略都有特定的格式要求。
- 复杂的编辑可能需要仔细选择策略或手动审查。

---

## 工作原理

当调用 `apply_diff` 工具时，它遵循以下流程：

1.  **参数验证**：验证必填的 `path` 和 `diff` 参数。
2.  **RooIgnore 检查**：验证目标文件路径是否符合 `.rooignore` 规则。
3.  **文件分析**：加载目标文件内容。
4.  **匹配查找**：使用模糊匹配算法（基于归一化字符串的 Levenshtein 距离）并结合 `:start_line:` 提示，在上下文窗口（`BUFFER_LINES`）内从中向外搜索，根据置信度阈值定位目标内容。
5.  **更改准备**：通过替换识别出的代码块生成建议的更改。
6.  **用户交互**：
    *   以差异视图形式显示更改。
    *   允许用户查看并可能编辑建议的更改。
    *   等待用户批准或拒绝。
7.  **应用更改**：如果获得批准，将应用更改（可能包括用户的编辑）到文件中。
8.  **错误处理**：如果发生错误（例如匹配失败、部分应用），会增加文件的 `consecutiveMistakeCountForApplyDiff` 并报告失败类型。
9. **反馈**：返回结果，包括任何用户反馈或错误详情。

---

## 差异格式要求

`<diff>` 参数需要特定的格式支持，允许在单个请求中包含一个或多个更改。每个更改块都需要原始内容的行号提示。

*   **要求**：`SEARCH` 块的内容（包括空格和缩进）必须精确匹配（在模糊阈值范围内）。每个块内必须包含 `:start_line:` 行号提示。`:end_line:` 提示是可选的（但解析器支持）。在 `SEARCH` 块中，像 `<<<<<<<` 这样的标记必须进行转义（`\\`）。

差异块的示例格式：

```diff
<<<<<<< SEARCH
:start_line:10
:end_line:12
-------
    // 旧的计算逻辑
    const result = value * 0.9;
    return result;
=======
    // 更新后的带日志记录的计算逻辑
    console.log(`Calculating for value: ${value}`);
    const result = value * 0.95; // 调整后的系数
    return result;
>>>>>>> REPLACE

<<<<<<< SEARCH
:start_line:25
:end_line:25
-------
    const defaultTimeout = 5000;
=======
    const defaultTimeout = 10000; // 增加了超时时间
>>>>>>> REPLACE
```

---

## 实验性功能：多文件编辑（`MULTI_FILE_APPLY_DIFF`）

`apply_diff` 的一个实验性版本允许在单个工具调用中对多个文件进行更改。此功能通过 `MULTI_FILE_APPLY_DIFF` 实验标志激活。

### 实验模式的关键功能

- **多文件操作**：在一个请求中编辑多个文件，简化复杂的重构任务。
- **批量审批 UI**：当目标为多个文件时，会出现一个单一的 UI，用户可以一次性批准或拒绝所有更改，或单独管理每个文件的权限。
- **新 XML 格式**：引入了一种新的、更结构化的 XML 格式，使用 `<args>` 和 `<file>` 标签来处理多个操作。
- **向后兼容性**：实验性工具保持与旧版单文件 `path` 和 `diff` 参数格式的兼容性。

### 工作原理（实验性）

1.  **实验检查**：工具首先检查 `MULTI_FILE_APPLY_DIFF` 实验是否启用。如果没有，它会回退到旧版 `apply_diff` 实现。
2.  **参数解析**：解析新的 `<args>` XML 格式以识别所有目标文件及其相应的差异操作。它也可以处理旧版 `path`/`diff` 参数。
3.  **验证和审批**：
    *   验证所有目标文件是否存在且可访问（未被 `.rooignore` 阻止）。
    *   如果要修改多个文件，会向用户显示一个**批量审批**对话框。
4.  **应用差异**：对于每个已批准的文件，使用 `MultiFileSearchReplaceDiffStrategy` 应用指定的差异。此策略可以对单个文件应用多个、不重叠的更改。
5.  **结果**：返回一个汇总结果消息，总结所有尝试操作的结果。

### 新差异格式（实验性）

实验模式在 `<apply_diff>` 工具调用中使用一种新的 XML 结构。

- **`<args>`**：包含所有文件操作的容器。
- **`<file>`**：每个要修改的文件的块。包含 `<path>` 和一个或多个 `<diff>` 标签。
- **`<path>`**：文件的相对路径。
- **`<diff>`**：包含更改的块。
    - **`<content>`**：`SEARCH/REPLACE` 块。
    - **`<start_line>`**：（可选）行号提示。

**示例：一次调用中修改两个文件**

```xml
<apply_diff>
  <args>
    <file>
      <path>src/services/auth.service.ts</path>
      <diff>
        <content>
<<<<<<< SEARCH
:start_line:50
-------
    const token_expiration = '15m';
>>>>>>> REPLACE
        </content>
      </diff>
    </file>
    <file>
      <path>src/config/auth.config.ts</path>
      <diff>
        <content>
<<<<<<< SEARCH
:start_line:12
-------
    rateLimit: 5,
=======
    rateLimit: 10,
>>>>>>> REPLACE
        </content>
      </diff>
    </file>
  </args>
</apply_diff>