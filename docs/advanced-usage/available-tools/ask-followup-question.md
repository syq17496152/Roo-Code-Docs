# ask_followup_question

`ask_followup_question` 工具通过提出具体问题来获取完成任务所需的信息，从而实现交互式通信。

---

## 参数

该工具接受以下参数：

- `question` (必填)：需要向用户提出的具体问题
- `follow_up` (可选)：包含 2-4 个建议答案的列表，每个答案用 `<suggest>` 标签包裹

---

## 功能说明

此工具在 Roo 与用户之间创建了一个对话界面，允许在面对模糊性或决策点时收集澄清信息、额外细节或用户偏好。每个问题都可以包含建议的回答，以简化交互过程。

---

## 使用场景

- 当原始请求中缺少关键信息时
- 当 Roo 需要在多个有效的实现方法之间进行选择时
- 当需要技术细节或偏好以继续操作时
- 当 Roo 遇到需要解决的模糊之处时
- 当额外的上下文可以显著提高解决方案质量时

---

## 主要功能

- 提供了一种结构化的方式来收集特定信息而不中断工作流程
- 包含建议的答案以减少用户输入并引导回应
- 在交互过程中维护会话历史和上下文
- 支持包含图像和代码片段的响应
- 作为 "始终可用" 的工具集的一部分，在所有模式下都可用
- 允许用户直接指导实现决策
- 使用 `<answer>` 标签将响应与普通对话区分开来
- 成功使用后重置连续错误计数器

---

## 局限性

- 每次工具使用只能提出一个具体问题
- 在 UI 中将建议显示为可选项
- 无法强制要求结构化响应 - 用户仍可以自由回应
- 过度使用会减慢任务完成速度并导致体验碎片化
- 建议答案必须完整，不能包含需要用户编辑的占位符
- 对用户响应没有内置验证机制
- 没有机制强制特定回答格式

---

## 工作原理

当调用 `ask_followup_question` 工具时，它遵循以下流程：

1. **参数验证**：验证必填的 `question` 参数并检查可选的建议答案
   - 确保提供了问题文本
   - 使用 `fast-xml-parser` 库解析 `follow_up` 参数中的任何建议答案
   - 即使只有一个建议，也将其规范化为数组格式

2. **JSON 转换**：将 XML 结构转换为标准化的 JSON 格式以供 UI 显示
   ```typescript
   {
     question: "用户的问题在这里",
     suggest: [
       { answer: "建议 1" },
       { answer: "建议 2" }
     ]
   }
   ```

3. **UI 集成**：
   - 通过 `ask("followup", ...)` 方法将 JSON 结构传递给 UI 层
   - 在界面中向用户显示可选的建议按钮
   - 创建用于选择或键入响应的交互式体验

4. **响应收集和处理**：
   - 捕获用户的文本输入和响应中包含的任何图片
   - 在返回给助手时，将用户响应包装在 `<answer>` 标签中
   - 保留用户响应中包含的图片
   - 通过将响应添加到历史记录中来维护对话上下文
   - 在工具成功使用时重置连续错误计数器

5. **错误处理**：
   - 使用计数器跟踪连续错误
   - 在成功使用工具时重置计数器
   - 提供特定的错误消息：
     - 对于缺失参数："Missing required parameter 'question'"
     - 对于 XML 解析："Failed to parse operations: [error message]"
     - 对于无效格式："Invalid operations xml format"
   - 包含防止在缺少必需参数时执行工具的安全措施
   - 在发生错误时增加连续错误计数

---

## 工作流程序列

问答循环遵循以下序列：

1. **信息缺口识别**：Roo 识别出需要继续操作的缺失信息
2. **具体问题创建**：Roo 制定一个清晰、有针对性的问题
3. **建议开发**：Roo 创建相关的建议答案（可选但推荐）
4. **工具调用**：助手用问题和可选建议调用工具
5. **UI 展示**：问题和建议以交互元素的形式展示给用户
6. **用户响应**：用户选择一个建议或提供自定义答案
7. **消息处理**：系统处理部分和完整的消息
   - 对于流式响应，逐块处理到达的内容
   - 对于完整消息，一次性处理整个响应
   - 不管消息分块如何，保持状态一致性
8. **响应处理**：系统将响应包装在 `<answer>` 标签中并保留图片
9. **上下文集成**：响应被添加到对话历史中
10. **任务继续**：Roo 使用新信息继续执行任务

---

## 使用示例

关于实现偏好的提问：
```
<ask_followup_question>
<question>您希望这个 Web 应用采用哪种样式框架？</question>
<follow_up>
<suggest>使用 Bootstrap 进行快速开发并获得一致的组件</suggest>
<suggest>使用 Tailwind CSS 实现实用优先且最大灵活的样式设计</suggest>
<suggest>使用 vanilla CSS 自定义样式以获得完全控制和最小依赖</suggest>
</follow_up>
</ask_followup_question>
```

请求技术澄清：
```
<ask_followup_question>
<question>这个应用应该使用什么数据库来存储用户数据？</question>
<follow_up>
<suggest>MongoDB，用于灵活的模式和文档存储</suggest>
<suggest>PostgreSQL，用于具有强一致性保证的关系型数据</suggest>
<suggest>Firebase，用于实时更新和简化的后端管理</suggest>
<suggest>SQLite，用于轻量级本地存储且无需外部依赖</suggest>
</follow_up>
</ask_followup_question>
```

解决需求中的模糊性：
```
<ask_followup_question>
<question>应用应该如何处理用户认证？</question>
<follow_up>
<suggest>实施带有账户验证的电子邮件/密码认证</suggest>
<suggest>使用社交登录提供商（Google、GitHub 等）实现快速注册</suggest>
<suggest>同时实现电子邮件/密码和社交登录选项</suggest>
</follow_up>
</ask_followup_question>