# browser_action

`browser_action` 工具通过 Puppeteer 控制的浏览器启用网页自动化和交互。它允许 Roo 启动浏览器、导航到网站、点击元素、输入文本和滚动页面，并通过屏幕截图提供视觉反馈。

---

## 参数

该工具接受以下参数：

- `action` (必填)：要执行的操作：
  * `launch`：在指定 URL 启动新的浏览器会话
  * `click`：点击指定的 x,y 坐标
  * `type`：通过键盘输入文本
  * `scroll_down`：向下滚动一个页面高度
  * `scroll_up`：向上滚动一个页面高度
  * `close`：结束浏览器会话
- `url` (可选)：使用 `launch` 操作时要导航的 URL
- `coordinate` (可选)：`click` 操作使用的 x,y 坐标（例如："450,300"）
- `text` (可选)：使用 `type` 操作时要输入的文本

---

## 功能说明

此工具创建一个 Roo 可以控制的自动化浏览器会话，以浏览网站、与元素交互，并执行需要浏览器自动化的任务。每个操作都提供当前状态的屏幕截图，实现流程的视觉验证。

---

## 使用场景

- 当 Roo 需要与 Web 应用程序或网站交互时
- 当测试用户界面或 Web 功能时
- 当捕获网页屏幕截图时
- 当以可视化方式演示 Web 工作流程时

---

## 主要功能

- 每个操作后提供带有屏幕截图的视觉反馈，并捕获控制台日志
- 支持从启动到页面交互再到关闭的完整工作流程
- 通过坐标、键盘输入和滚动实现精确交互
- 使用智能页面加载检测维护一致的浏览器会话
- 支持两种模式：本地（隔离的 Puppeteer 实例）或远程（连接到现有 Chrome）
- 通过自动会话清理和详细消息优雅地处理错误
- 通过支持各种格式和质量设置优化视觉输出
- 通过位置指示器和操作历史记录跟踪交互状态

---

## 浏览器模式

该工具在两种不同模式下运行：

### 本地浏览器模式（默认）
- 通过 Puppeteer 下载并管理本地 Chromium 实例
- 每次启动时创建新的浏览器环境
- 无法访问现有的用户配置文件、cookie 或扩展程序
- 在沙盒环境中提供一致、可预测的行为
- 会话结束时完全关闭浏览器

### 远程浏览器模式
- 连接到运行远程调试模式的现有 Chrome/Chromium 实例
- 可以访问现有的浏览器状态、cookie 和潜在的扩展程序
- 由于重用现有浏览器进程，启动速度更快
- 支持连接到 Docker 容器或远程机器上的浏览器
- 会话结束时仅断开连接（不关闭）浏览器
- 要求 Chrome 在打开远程调试端口（通常为 9222 端口）的情况下运行

---

## 局限性

- 浏览器活动时，只能使用 `browser_action` 工具
- 浏览器坐标是视口相对的，而不是页面相对的
- 点击操作必须定位视口内可见的元素
- 在使用其他工具之前必须显式关闭浏览器会话
- 浏览器窗口有可配置的尺寸（默认 900x600）
- 无法直接与浏览器 DevTools 交互
- 浏览器会话是临时的，不会在 Roo 重启后持久化
- 仅适用于 Chrome/Chromium 浏览器，不适用于 Firefox 或 Safari
- 本地模式无法访问现有 cookie；远程模式需要启用调试的 Chrome

---

## 工作原理

当调用 `browser_action` 工具时，它遵循以下流程：

1. **动作验证和浏览器管理**：
   - 验证请求动作所需的参数
   - 对于 `launch`：初始化浏览器会话（本地 Puppeteer 实例或远程 Chrome）
   - 对于交互动作：使用现有的浏览器会话
   - 对于 `close`：适当终止或断开与浏览器的连接

2. **页面交互和稳定性**：
   - 使用 `waitTillHTMLStable` 算法通过 DOM 稳定性检测确保页面完全加载
   - 按照适当的时间执行请求的操作（导航、点击、输入、滚动）
   - 在点击后监控网络活动，并在需要时等待导航

3. **视觉反馈**：
   - 使用 WebP 格式（支持 PNG 回退）捕获优化的屏幕截图
   - 记录浏览器控制台日志以供调试
   - 跟踪鼠标位置并维护操作的分页历史记录

4. **会话管理**：
   - 跨多个操作维护浏览器状态
   - 处理错误并自动清理资源
   - 强制执行正确的操作流程（启动 → 交互 → 关闭）

---

## 工作流程序列

浏览器交互必须遵循以下特定序列：

1. **会话初始化**：所有浏览器工作流程必须以 `launch` 动作开始
2. **交互阶段**：可以执行多个 `click`、`type` 和滚动动作
3. **会话终止**：所有浏览器工作流程必须以 `close` 动作结束
4. **工具切换**：关闭浏览器后，可以使用其他工具

---

## 使用示例

创建网页表单提交流程：
```
<browser_action>
<action>launch</action>
<url>https://example.com</url>
</browser_action>
```

点击特定坐标（例如按钮）：
```
<browser_action>
<action>click</action>
<coordinate>450,300</coordinate>
</browser_action>
```

在聚焦的输入字段中输入文本：
```
<browser_action>
<action>type</action>
<text>Hello, World!</text>
</browser_action>
```

向下滚动查看更多内容：
```
<browser_action>
<action>scroll_down</action>
</browser_action>
```

关闭浏览器会话：
```
<browser_action>
<action>close</action>
</browser_action>
```