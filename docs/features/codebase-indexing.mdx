import Codicon from '@site/src/components/Codicon';

# 代码库索引

代码库索引通过使用AI嵌入创建语义搜索索引，彻底改变了Roo Code理解项目的方式。它不依赖精确的文本匹配，而是理解查询的*含义*，帮助Roo找到相关代码，即使你不知道具体的函数名或文件位置。

<img src="/img/codebase-indexing/codebase-indexing-1.png" alt="代码库索引状态图标" />

---

## 主要功能

启用后，索引系统会：

1. **解析代码** 使用Tree-sitter识别语义块（函数、类、方法）
2. **创建嵌入** 使用AI模型对每个代码块进行向量化
3. **存储向量** 到Qdrant数据库实现快速相似性搜索
4. **提供 [`codebase_search`](/advanced-usage/available-tools/codebase-search) 工具** 供Roo进行智能代码发现

这使得可以通过自然语言查询如"用户认证逻辑"或"数据库连接处理"在整个项目中查找相关代码。


---

## 快速入门指南

:::tip 💰 完全免费的设置方案
可以通过以下方式零成本搭建代码库索引：
- **Qdrant Cloud**（免费套餐）或 **Docker Qdrant**（完全免费）
- **Google Gemini**（当前免费）

这可以让你获得专业级的语义搜索功能而无需订阅费用！
:::

### 第1步：选择配置方案

启用代码库索引前，需要准备两个组件：

1. **嵌入提供者** - 将代码转换为可搜索向量
2. **向量数据库** - 存储和搜索这些向量

### 第2步：配置Qdrant（向量数据库）

#### 选项A：云端配置（推荐入门）- **免费**

1. 在 [Qdrant Cloud](https://cloud.qdrant.io/) 注册（提供免费套餐）
2. 创建集群
3. 复制你的URL和API密钥

#### 选项B：本地配置 - **免费**

使用Docker：
```bash
docker run -p 6333:6333 qdrant/qdrant
```

使用Docker Compose：
```yaml
version: '3.8'
services:
  qdrant:
    image: qdrant/qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage
volumes:
  qdrant_storage:
```

### 第3步：配置嵌入提供者

#### Google Gemini配置（推荐）- **免费**

1. 从 [Google AI Studio](https://aistudio.google.com/apikey) 获取API密钥（当前免费）
2. 在Roo Code设置中：
   - 提供者：**Google Gemini**
   - API密钥：你的Google AI Studio密钥

:::info 其他可用提供者
虽然本指南重点介绍当前免费的Google Gemini，但Roo Code还支持OpenAI、Ollama和兼容OpenAI的提供者。你可以在配置下拉菜单中探索这些选项。
:::

### 第4步：保存配置

1. 点击 **保存** 并 **开始索引**

状态指示器会显示：
- **黄色（索引中）**：正在处理文件
- **绿色（已索引）**：准备就绪可搜索
- **红色（错误）**：请查看故障排除部分

---

## 索引器的管理与配置

你可以直接从Roo Code聊天界面监控状态并管理所有配置。

### 状态图标

在聊天输入框的右下角，你会找到**代码库索引状态图标**。该图标提供索引器当前状态的快速概览。

<img src="/img/codebase-indexing/codebase-indexing-1.png" alt="代码库索引状态图标" />

图标颜色表示状态：

- 🟢 **绿色**：**已索引**。索引是最新的，准备进行搜索。
- 🟡 **黄色**：**索引中**。系统正在积极处理文件。仍可执行搜索，但结果可能不完整。
- 🔴 **红色**：**错误**。发生问题（例如无法连接Qdrant或嵌入提供者）。请参阅故障排除部分获取帮助。
- ⚪ **灰色**：**待机**。索引器在等待配置或已被禁用。

### 配置弹出窗口

点击状态图标会打开主配置弹出窗口。在这里，你可以查看详细状态并管理所有设置。

<img src="/img/codebase-indexing/codebase-indexing-2.png" alt="代码库索引配置弹出窗口" />

- **状态**：显示当前状态的详细信息，例如"已索引 - 文件监视器已启动"或正在进行的扫描进度。
- **配置**：包含连接嵌入提供者和向量数据库的主要字段。
- **高级配置**：允许你微调搜索参数，如相似度阈值。
- **清除索引数据**：删除Qdrant集合中的所有数据并清除本地文件缓存。当你想要从头开始重新索引整个项目时使用此功能。**此操作不可撤销**。
- **保存**：应用你的配置更改。如果更改了关键设置（如API密钥或模型），索引器将自动重启。

### 详细配置字段

本指南解释了配置弹出窗口中每个可用设置的功能。

<img src="/img/codebase-indexing/codebase-indexing-3.png" alt="代码库索引配置详情" />

#### **配置字段**

- **嵌入提供者**
  - **用途**：选择生成AI嵌入的来源。
  - **行为**：此下拉菜单决定显示哪些配置字段。可选选项包括**OpenAI**、**Google Gemini**、**Ollama**和**OpenAI兼容**。

- **API密钥**（适用于OpenAI、Gemini、OpenAI兼容）
  - **用途**：用于验证所选提供者的密钥。
  - **行为**：所有基于云的提供者都需要此输入，并安全存储在你的VS Code加密存储中。

- **基础URL**（适用于Ollama、OpenAI兼容）
  - **用途**：连接提供者API的端点。
  - **行为**：对于**Ollama**，通常是`http://localhost:11434`。对于Azure等**OpenAI兼容**提供者，这是完整的部署URL。

- **模型**
  - **用途**：选择要使用的特定嵌入模型。
  - **行为**：可用模型列表根据所选提供者而变化。显示模型的向量维度（例如`1536维度`），因为更改维度需要完全重新索引。

- **Qdrant URL**
  - **用途**：Qdrant向量数据库的连接端点。
  - **行为**：必须是有效的URL，指向你的本地或云Qdrant实例（例如`http://localhost:6333`）。

- **Qdrant API密钥**
  - **用途**：受保护Qdrant实例的认证密钥。
  - **行为**：此字段是可选的，仅当你的Qdrant部署需要API密钥时才应使用。

#### **高级配置字段**

- **搜索评分阈值**
  - **用途**：控制代码片段被视为匹配所需的最小相似度评分。
  - **行为**：使用滑块设置0.0到1.0之间的值。较低的值返回更多（但可能不太相关）的结果，而较高的值返回更少、更精确的结果。
  - **推荐设置**：
    - **低（0.15-0.3）**：广泛的结果，适合探索
    - **中（0.4-0.5）**：平衡精度和召回率（默认：0.4）
    - **高（0.6-0.8）**：仅精确匹配

- **最大搜索结果数**
  - **用途**：设置单次`codebase_search`返回的代码片段最大数量。
  - **行为**：使用滑块调整限制。这有助于控制提供给AI的上下文量。

---

## 主要优势

- **语义搜索**：通过含义而非关键词查找代码
- **增强的AI理解**：Roo可以更好地理解和处理你的代码库
- **跨项目发现**：搜索所有文件，而不仅仅是打开的文件
- **模式识别**：定位类似的实现和代码模式

---

## 文件处理方式

### 智能代码解析

系统使用复杂的解析策略：

1. **优先使用Tree-sitter**：对于支持的语言，使用AST解析识别语义代码块（函数、类、方法）
2. **Markdown支持**：通过将标题视为语义入口点来索引Markdown文件
3. **智能回退**：对于不支持的文件类型，回退到基于行的分块

**块大小**：
- 最小：100字符
- 最大：1,000字符
- 大型函数会在逻辑边界处智能拆分

### 文件过滤

索引器尊重你的项目忽略模式：
- 匹配`.gitignore`模式的文件
- 匹配`.rooignore`模式的文件
- 二进制文件和图片
- 大于1MB的文件

**重要**：确保你的`.gitignore`包含常见的依赖文件夹如`node_modules`、`vendor`、`target`等，因为系统完全依赖这些模式进行过滤。

### 增量更新

- **文件监视**：实时监控工作区的变化
- **智能更新**：只重新处理修改过的文件
- **分支感知**：自动处理Git分支切换
- **哈希缓存**：避免重新处理未更改的内容

---

## 最佳实践

### 编写有效查询

不要搜索确切的语法：
- ❌ `const getUser`
- ✅ `从数据库获取用户的函数`

使用自然语言描述：
- "认证中间件"
- "API请求的错误处理"
- "数据库连接设置"

### 安全考虑

- **API密钥**：安全存储在VS Code的加密存储中
- **代码隐私**：仅发送小段代码进行嵌入
- **本地处理**：所有解析都在本地进行
- **访问控制**：尊重文件权限和忽略模式

---

## 故障排除

### 连接问题

**"无法连接Qdrant"**
- 确保Qdrant正在运行（用`docker ps`检查）
- 验证URL是否匹配（默认：`http://localhost:6333`）
- 检查防火墙/网络策略
- 对于云实例，确认URL和API密钥

**"无效的API密钥"或"401未授权"**
- 双重检查API密钥是否正确
- 确保密钥具有必要权限
- 对于Ollama，验证服务是否运行

### 模型问题

**"未找到模型"**
- 对于Google Gemini：确保模型名称正确（例如`text-embedding-004`）
- 对于其他提供者：查阅其文档了解可用模型和正确命名

### 索引问题

**"卡在错误状态"**
1. 首先检查连接问题
2. 点击设置中的"清除索引并重新索引"
3. 这将解决缓存或集合损坏问题

**"索引耗时过长"**
- 对于大型代码库（10k+文件）是正常的
- 检查`.gitignore`是否包含大型目录
- 考虑在`.rooignore`中添加模式

---

## 使用搜索功能

一旦完成索引，Roo就可以使用[`codebase_search`](/advanced-usage/available-tools/codebase-search)工具：

**自然语言查询示例**：
- "用户认证是如何处理的？"
- "数据库连接设置"
- "错误处理模式"
- "API端点定义"
- "组件状态管理"

该工具提供：
- 相关代码片段
- 带行号的文件路径
- 相似度评分
- 直接导航链接

---

## 隐私与数据安全

**你的代码保持私有**：
- 仅发送小段代码（100-1000字符）进行嵌入
- 嵌入是一次性的数学表示
- 本地解析意味着完整文件永远不会离开你的机器
- 使用Ollama实现完全离线操作

**数据存储**：
- 向量存储在你选择的Qdrant实例中
- 你控制数据的存储位置（本地/云端）
- 轻松删除：只需清除索引

---

## 当前限制

- **文件大小**：每个文件最大1MB
- **单个工作区**：一次只能索引一个工作区
- **外部依赖**：需要嵌入提供者+Qdrant
- **语言支持**：Tree-sitter支持的语言效果最佳

---

## 未来改进

计划中的改进：
- 增加嵌入提供者
- 多工作区索引
- 增强的过滤选项
- 团队协作功能
- VS Code原生搜索集成
- 增量重新索引优化